<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CallChat ‚Äì Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --cc-brand:#0ea5e9;/* sky-500 */
      --cc-brand-2:#0369a1;/* sky-700 */
      --cc-bg:#f6f7fb;
    }
    body{background:var(--cc-bg)}
    header.cc-appbar{background:linear-gradient(90deg,var(--cc-brand),var(--cc-brand-2));color:#fff}
    .cc-card{border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .cc-sidebar{width:320px;max-width:100%;border-right:1px solid #eaeaea}
    .cc-chat{min-height:60vh;height:calc(100vh - 180px)}
    .msg{max-width:80%;padding:10px 14px;border-radius:14px;margin:4px 0;display:inline-block}
    .msg.me{background:#dcfce7;align-self:flex-end}
    .msg.other{background:#f1f5f9}
    .cc-scroll{overflow:auto}
    .cc-badge{font-size:.75rem}
    .cc-rtl{direction:rtl}
    .cc-list-item:hover{background:#f8fafc}
    .cc-pill{border-radius:999px}
    .cc-empty{opacity:.6}
  </style>
</head>
<body>
  <!-- AUTH / WELCOME -->
  <div id="screen-auth" class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-6">
        <div class="cc-card bg-white p-4">
          <div class="text-center mb-3">
            <div class="display-6">üìû CallChat</div>
            <div class="text-muted" id="i_welcome">Hello! Welcome to CallChat!</div>
          </div>
          <div class="mb-3">
            <label class="form-label" id="i_select_lang_label">Please select your language</label>
            <div class="d-flex gap-2">
              <select id="lang" class="form-select">
                <option value="en" selected>English</option>
                <option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
              </select>
              <button id="btnLang" class="btn btn-outline-primary">Select</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label" id="i_phone_label">Enter your phone number</label>
            <input type="tel" id="phone" class="form-control" placeholder="e.g. +98912xxxxxxx" />
            <div class="form-text" id="i_privacy">No code. Offline demo ‚Äì stored on your device only.</div>
          </div>
          <div class="d-grid">
            <button id="btnLogin" class="btn btn-primary">Continue</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="screen-app" class="d-none">
    <header class="cc-appbar py-3">
      <div class="container d-flex justify-content-between align-items-center">
        <div class="fs-4 fw-semibold">üìû CallChat <span class="cc-badge badge bg-light text-dark ms-2" id="badgeUser"></span></div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-light" id="btnLogout">Logout</button>
        </div>
      </div>
    </header>

    <div class="container my-3">
      <div class="row g-3">
        <!-- Sidebar -->
        <div class="col-lg-4">
          <div class="bg-white cc-card">
            <ul class="nav nav-pills nav-fill p-2">
              <li class="nav-item"><button class="nav-link active" data-cc-tab="chats" id="tabChats">Chats</button></li>
              <li class="nav-item"><button class="nav-link" data-cc-tab="groups" id="tabGroups">Groups</button></li>
              <li class="nav-item"><button class="nav-link" data-cc-tab="channels" id="tabChannels">Channels</button></li>
              <li class="nav-item"><button class="nav-link" data-cc-tab="contacts" id="tabContacts">Contacts</button></li>
            </ul>
            <div class="p-2 border-top">
              <input id="search" class="form-control" placeholder="Search‚Ä¶" />
            </div>
            <div class="p-2 d-flex gap-2 border-top">
              <button class="btn btn-sm btn-success flex-fill" id="btnNewChat">New Chat</button>
              <button class="btn btn-sm btn-warning flex-fill" id="btnNewGroup">New Group</button>
              <button class="btn btn-sm btn-info flex-fill" id="btnNewChannel">New Channel</button>
            </div>
            <div id="list" class="cc-scroll p-2" style="height:56vh"></div>
          </div>
        </div>

        <!-- Chat area -->
        <div class="col-lg-8">
          <div class="bg-white cc-card p-3 d-flex flex-column" style="height:calc(56vh + 112px)">
            <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
              <div>
                <div class="fw-semibold" id="title">‚Äî</div>
                <div class="text-muted small" id="subtitle">Select a chat</div>
              </div>
              <div id="headerActions" class="d-flex gap-2"></div>
            </div>

            <div id="messages" class="cc-scroll flex-grow-1 d-flex flex-column p-2"></div>

            <div id="composer" class="pt-2 d-flex gap-2">
              <input id="inputMsg" class="form-control" placeholder="Type a message‚Ä¶" />
              <button id="btnSend" class="btn btn-primary">Send</button>
            </div>
            <div id="composerHint" class="text-muted small d-none">Only owners can post in a channel.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="modalNewChat" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Start new chat</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <label class="form-label">Contact phone</label>
          <input id="mc_phone" class="form-control" placeholder="e.g. +98912‚Ä¶" />
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-primary" id="mc_create">Create</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalNewGroup" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Create group</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <label class="form-label">Group title</label>
          <input id="mg_title" class="form-control" placeholder="My group" />
          <label class="form-label mt-3">Members (comma-separated phones)</label>
          <input id="mg_members" class="form-control" placeholder="+98912‚Ä¶ , +98913‚Ä¶" />
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-warning" id="mg_create">Create</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalNewChannel" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Create channel</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <label class="form-label">Channel title</label>
          <input id="mc_title2" class="form-control" placeholder="My channel" />
          <label class="form-label mt-3">Owners (comma-separated phones). Only owners can post.</label>
          <input id="mc_owners" class="form-control" placeholder="+98912‚Ä¶ , +98913‚Ä¶" />
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-info" id="mch_create">Create</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== i18n (English / Persian)
    const i18n = {
      en: {
        welcome: "Hello! Welcome to CallChat!",
        selectLang: "Please select your language",
        phoneLabel: "Enter your phone number",
        privacy: "No code. Offline demo ‚Äì stored on your device only.",
        continue: "Continue",
        logout: "Logout",
        chats: "Chats", groups: "Groups", channels: "Channels", contacts: "Contacts",
        search: "Search‚Ä¶", newChat: "New Chat", newGroup: "New Group", newChannel: "New Channel",
        startNewChat: "Start new chat", contactPhone: "Contact phone", create: "Create",
        createGroup: "Create group", title: "Title", members: "Members",
        createChannel: "Create channel", owners: "Owners",
        onlyOwners: "Only owners can post in a channel.",
        selectAChat: "Select a chat",
      },
      fa: {
        welcome: "ÿ≥ŸÑÿßŸÖ! ÿ®Ÿá ⁄©ÿßŸÑ‚Äå⁄Üÿ™ ÿÆŸàÿ¥ ÿßŸàŸÖÿØ€å!",
        selectLang: "ŸÑÿ∑ŸÅÿßŸã ÿ≤ÿ®ÿßŸÜ ÿ±Ÿà ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ",
        phoneLabel: "ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ ÿ±Ÿà Ÿàÿßÿ±ÿØ ⁄©ŸÜ",
        privacy: "ÿ®ÿØŸàŸÜ ⁄©ÿØ. ÿØŸÖŸà ÿ¢ŸÅŸÑÿß€åŸÜ ‚Äî ŸÅŸÇÿ∑ ÿ±Ÿà€å ÿØÿ≥ÿ™⁄ØÿßŸá ÿÆŸàÿØÿ™ ÿ∞ÿÆ€åÿ±Ÿá ŸÖ€å‚Äåÿ¥ŸàÿØ.",
        continue: "ÿßÿØÿßŸÖŸá",
        logout: "ÿÆÿ±Ÿàÿ¨",
        chats: "⁄ØŸÅÿ™⁄ØŸàŸáÿß", groups: "⁄Øÿ±ŸàŸá‚ÄåŸáÿß", channels: "⁄©ÿßŸÜÿßŸÑ‚ÄåŸáÿß", contacts: "ŸÖÿÆÿßÿ∑ÿ®ÿßŸÜ",
        search: "ÿ¨ÿ≥ÿ™ÿ¨Ÿà‚Ä¶", newChat: "⁄ØŸÅÿ™⁄ØŸà€å ÿ¨ÿØ€åÿØ", newGroup: "⁄Øÿ±ŸàŸá ÿ¨ÿØ€åÿØ", newChannel: "⁄©ÿßŸÜÿßŸÑ ÿ¨ÿØ€åÿØ",
        startNewChat: "ÿ¥ÿ±Ÿàÿπ ⁄ØŸÅÿ™⁄ØŸà", contactPhone: "ÿ¥ŸÖÿßÿ±Ÿá ŸÖÿÆÿßÿ∑ÿ®", create: "ÿß€åÿ¨ÿßÿØ",
        createGroup: "ÿ≥ÿßÿÆÿ™ ⁄Øÿ±ŸàŸá", title: "ÿπŸÜŸàÿßŸÜ", members: "ÿßÿπÿ∂ÿß",
        createChannel: "ÿ≥ÿßÿÆÿ™ ⁄©ÿßŸÜÿßŸÑ", owners: "ŸÖÿØ€åÿ±Ÿáÿß",
        onlyOwners: "ŸÅŸÇÿ∑ ŸÖÿØ€åÿ±ÿßŸÜ ⁄©ÿßŸÜÿßŸÑ ŸÖ€å‚Äåÿ™ŸàÿßŸÜŸÜÿØ Ÿæ€åÿßŸÖ ÿ®ŸÅÿ±ÿ≥ÿ™ŸÜÿØ.",
        selectAChat: "€å⁄© ⁄ØŸÅÿ™⁄ØŸà ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ",
      }
    };

    // ===== Simple DB in localStorage (offline demo)
    const DBKEY = 'callchat_db_v1';
    const loadDB = () => JSON.parse(localStorage.getItem(DBKEY) || '{}');
    const saveDB = (db) => localStorage.setItem(DBKEY, JSON.stringify(db));

    // schema: { users: { phone: {phone, name} }, chats:[{id,type:'dm'|'group'|'channel',title, members:[phones], owners:[phones]}], messages:{ chatId: [ {from, text, ts} ] }, currentUser: phone }

    function initDB(){
      const db = loadDB();
      if(!db.users){ db.users = {}; }
      if(!db.chats){ db.chats = []; }
      if(!db.messages){ db.messages = {}; }
      saveDB(db);
    }

    // ===== Auth screen
    const screenAuth = document.getElementById('screen-auth');
    const screenApp = document.getElementById('screen-app');
    const iWelcome = document.getElementById('i_welcome');
    const iSelectLabel = document.getElementById('i_select_lang_label');
    const iPhoneLabel = document.getElementById('i_phone_label');
    const iPrivacy = document.getElementById('i_privacy');
    const btnLang = document.getElementById('btnLang');
    const btnLogin = document.getElementById('btnLogin');
    const langSel = document.getElementById('lang');
    const phoneInput = document.getElementById('phone');

    let LANG = localStorage.getItem('cc_lang') || 'en';
    langSel.value = LANG;
    function applyLang(){
      const t = i18n[LANG];
      iWelcome.textContent = t.welcome;
      iSelectLabel.textContent = t.selectLang;
      iPhoneLabel.textContent = t.phoneLabel;
      iPrivacy.textContent = t.privacy;
      btnLogin.textContent = t.continue;
      document.body.classList.toggle('cc-rtl', LANG === 'fa');
      document.getElementById('tabChats').textContent = t.chats;
      document.getElementById('tabGroups').textContent = t.groups;
      document.getElementById('tabChannels').textContent = t.channels;
      document.getElementById('tabContacts').textContent = t.contacts;
      document.getElementById('search').placeholder = t.search;
      document.getElementById('btnNewChat').textContent = t.newChat;
      document.getElementById('btnNewGroup').textContent = t.newGroup;
      document.getElementById('btnNewChannel').textContent = t.newChannel;
      document.getElementById('subtitle').textContent = t.selectAChat;
      document.getElementById('composerHint').textContent = t.onlyOwners;
      document.querySelector('#modalNewChat .modal-title').textContent = t.startNewChat;
      document.querySelector('#modalNewChat label').textContent = t.contactPhone;
      document.querySelector('#modalNewChat #mc_create').textContent = t.create;
      document.querySelector('#modalNewGroup .modal-title').textContent = t.createGroup;
      document.querySelector('#modalNewGroup label').textContent = t.title;
      document.querySelector('#modalNewGroup #mg_members').previousElementSibling.textContent = t.members + ' (comma-separated phones)';
      document.querySelector('#modalNewGroup #mg_create').textContent = t.create;
      document.querySelector('#modalNewChannel .modal-title').textContent = t.createChannel;
      document.querySelector('#modalNewChannel label').textContent = t.title;
      document.querySelector('#modalNewChannel #mc_owners').previousElementSibling.textContent = t.owners + ' (comma-separated phones)';
      document.querySelector('#modalNewChannel #mch_create').textContent = t.create;
    }

    btnLang.addEventListener('click', ()=>{ LANG = langSel.value; localStorage.setItem('cc_lang', LANG); applyLang(); });

    btnLogin.addEventListener('click', ()=>{
      const phone = phoneInput.value.trim();
      if(!phone){ alert(LANG==='fa'? 'ÿ¥ŸÖÿßÿ±Ÿá ÿ±Ÿà Ÿàÿßÿ±ÿØ ⁄©ŸÜ' : 'Enter phone'); return; }
      initDB();
      const db = loadDB();
      db.currentUser = phone;
      if(!db.users[phone]) db.users[phone] = { phone, name: phone };
      saveDB(db);
      startApp();
    });

    // ===== App
    const badgeUser = document.getElementById('badgeUser');
    const btnLogout = document.getElementById('btnLogout');
    const listEl = document.getElementById('list');
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const messagesEl = document.getElementById('messages');
    const inputMsg = document.getElementById('inputMsg');
    const btnSend = document.getElementById('btnSend');
    const composer = document.getElementById('composer');
    const composerHint = document.getElementById('composerHint');
    const headerActions = document.getElementById('headerActions');

    let ACTIVE = null; // {id, type}
    let TAB = 'chats';

    function startApp(){
      screenAuth.classList.add('d-none');
      screenApp.classList.remove('d-none');
      applyLang();
      const db = loadDB();
      badgeUser.textContent = db.currentUser || '';
      renderList();
    }

    btnLogout.addEventListener('click', ()=>{
      const db = loadDB();
      delete db.currentUser; saveDB(db);
      screenApp.classList.add('d-none');
      screenAuth.classList.remove('d-none');
    });

    // Tabs
    document.querySelectorAll('[data-cc-tab]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('[data-cc-tab]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        TAB = btn.getAttribute('data-cc-tab');
        renderList();
      });
    });

    function renderList(){
      const db = loadDB();
      const me = db.currentUser;
      let items = [];
      if(TAB==='contacts'){
        items = Object.values(db.users).filter(u=>u.phone!==me);
      } else {
        items = db.chats.filter(ch=>{
          if(TAB==='chats' && ch.type==='dm') return ch.members.includes(me);
          if(TAB==='groups' && ch.type==='group') return ch.members.includes(me);
          if(TAB==='channels' && ch.type==='channel') return true;
          return false;
        });
      }
      const q = document.getElementById('search').value?.toLowerCase()||'';
      if(q){ items = items.filter(x=> (x.title||x.name||x.phone||'').toLowerCase().includes(q)); }

      listEl.innerHTML = '';
      if(items.length===0){ listEl.innerHTML = `<div class='text-center cc-empty p-4'>No items</div>`; return; }

      items.forEach(x=>{
        const div = document.createElement('div');
        div.className = 'p-2 cc-list-item d-flex align-items-center justify-content-between';
        if(TAB==='contacts'){
          div.innerHTML = `<div><div class='fw-semibold'>${x.name||x.phone}</div><div class='small text-muted'>${x.phone}</div></div><button class='btn btn-sm btn-outline-primary cc-pill'>Chat</button>`;
          div.querySelector('button').onclick = ()=>openDM(x.phone);
        } else {
          const meta = x.type==='dm' ? x.members.find(p=>p!==me) : (x.type);
          div.innerHTML = `<div><div class='fw-semibold'>${x.title||meta}</div><div class='small text-muted'>${x.type}</div></div>`;
          div.onclick = ()=>openChat(x.id);
        }
        listEl.appendChild(div);
      });
    }

    document.getElementById('search').addEventListener('input', renderList);

    function ensureChat(type, opts){
      const db = loadDB();
      let ch = null;
      if(type==='dm'){
        const me = db.currentUser; const other = opts.other;
        ch = db.chats.find(c=>c.type==='dm' && c.members.includes(me) && c.members.includes(other));
        if(!ch){ ch = { id: 'c_'+Date.now(), type:'dm', members:[me, other] }; db.chats.push(ch); saveDB(db); }
      }
      if(type==='group'){
        ch = { id:'c_'+Date.now(), type:'group', title: opts.title||'Group', members: Array.from(new Set([loadDB().currentUser, ...(opts.members||[])])) };
        db.chats.push(ch); saveDB(db);
      }
      if(type==='channel'){
        ch = { id:'c_'+Date.now(), type:'channel', title: opts.title||'Channel', owners: Array.from(new Set([loadDB().currentUser, ...(opts.owners||[])])) };
        db.chats.push(ch); saveDB(db);
      }
      if(!db.messages[ch.id]){ db.messages[ch.id] = []; saveDB(db); }
      return ch;
    }

    function openDM(other){
      const ch = ensureChat('dm', {other});
      openChat(ch.id);
    }

    function openChat(id){
      const db = loadDB();
      ACTIVE = db.chats.find(c=>c.id===id);
      if(!ACTIVE){ return; }
      titleEl.textContent = ACTIVE.title || (ACTIVE.type==='dm' ? ACTIVE.members.find(p=>p!==db.currentUser) : ACTIVE.type);
      subtitleEl.textContent = ACTIVE.type;

      headerActions.innerHTML = '';
      if(ACTIVE.type==='group'){
        const count = ACTIVE.members?.length||0;
        const span = document.createElement('span'); span.className='badge text-bg-secondary'; span.textContent = count+' members'; headerActions.appendChild(span);
      }
      if(ACTIVE.type==='channel'){
        const span = document.createElement('span'); span.className='badge text-bg-secondary'; span.textContent = 'channel'; headerActions.appendChild(span);
      }

      const messages = db.messages[id]||[];
      messagesEl.innerHTML = '';
      messages.forEach(m=>{
        const div = document.createElement('div');
        div.className = 'd-flex '+(m.from===db.currentUser?'justify-content-end':'justify-content-start');
        const b = document.createElement('div'); b.className='msg '+(m.from===db.currentUser?'me':'other'); b.textContent = m.text; div.appendChild(b);
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;

      if(ACTIVE.type==='channel' && !(ACTIVE.owners||[]).includes(db.currentUser)){
        composer.classList.add('d-none');
        composerHint.classList.remove('d-none');
      } else {
        composer.classList.remove('d-none');
        composerHint.classList.add('d-none');
      }
    }

    btnSend.addEventListener('click', ()=>{
      if(!ACTIVE) return;
      const text = inputMsg.value.trim(); if(!text) return; inputMsg.value='';
      const db = loadDB();
      const arr = db.messages[ACTIVE.id]||[]; arr.push({from: db.currentUser, text, ts: Date.now()}); db.messages[ACTIVE.id]=arr; saveDB(db);
      openChat(ACTIVE.id);
    });

    // Buttons new chat/group/channel
    const modalNewChat = new bootstrap.Modal('#modalNewChat');
    const modalNewGroup = new bootstrap.Modal('#modalNewGroup');
    const modalNewChannel = new bootstrap.Modal('#modalNewChannel');

    document.getElementById('btnNewChat').onclick = ()=> modalNewChat.show();
    document.getElementById('btnNewGroup').onclick = ()=> modalNewGroup.show();
    document.getElementById('btnNewChannel').onclick = ()=> modalNewChannel.show();

    document.getElementById('mc_create').onclick = ()=>{
      const phone = document.getElementById('mc_phone').value.trim(); if(!phone) return;
      // ensure contact exists
      const db = loadDB(); if(!db.users[phone]) db.users[phone]={phone,name:phone}; saveDB(db);
      modalNewChat.hide(); openDM(phone); renderList();
    };

    document.getElementById('mg_create').onclick = ()=>{
      const title = document.getElementById('mg_title').value.trim()||'Group';
      const members = document.getElementById('mg_members').value.split(',').map(s=>s.trim()).filter(Boolean);
      const db = loadDB(); members.forEach(p=>{ if(!db.users[p]) db.users[p]={phone:p,name:p}; }); saveDB(db);
      const ch = ensureChat('group',{title, members}); modalNewGroup.hide(); openChat(ch.id); renderList();
    };

    document.getElementById('mch_create').onclick = ()=>{
      const title = document.getElementById('mc_title2').value.trim()||'Channel';
      const owners = document.getElementById('mc_owners').value.split(',').map(s=>s.trim()).filter(Boolean);
      const db = loadDB(); owners.forEach(p=>{ if(!db.users[p]) db.users[p]={phone:p,name:p}; }); saveDB(db);
      const ch = ensureChat('channel',{title, owners}); modalNewChannel.hide(); openChat(ch.id); renderList();
    };

    // Startup: auto-login if record exists
    initDB();
    applyLang();
    const db0 = loadDB();
    if(db0.currentUser){ startApp(); }
  </script>
</body>
</html>


